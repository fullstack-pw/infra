name: Terraform

on:
  # pull_request:
  push:
    # types: [closed]
    branches:
      - main
    paths:
      # - "proxmox/**"
      - "clusters/**"
      - "secrets/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  wait-for-release:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Release Workflow
        run: |
          echo "Waiting for Release workflow to complete..."

          MAX_WAIT=300
          WAIT_INTERVAL=10
          ELAPSED=0
          REF="${{ github.event.pull_request.merge_commit_sha }}"
          REPO="${{ github.repository }}"

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            echo "Checking Release workflow status... (elapsed: ${ELAPSED}s)"
            
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/actions/runs?head_sha=$REF")
            
            RELEASE_RUN=$(echo "$RESPONSE" | jq -r '.workflow_runs[] | select(.name == "Release") | {status: .status, conclusion: .conclusion}')
            
            if [ "$RELEASE_RUN" != "null" ] && [ "$RELEASE_RUN" != "" ]; then
              STATUS=$(echo "$RELEASE_RUN" | jq -r '.status')
              CONCLUSION=$(echo "$RELEASE_RUN" | jq -r '.conclusion')
              
              echo "Release workflow - Status: $STATUS, Conclusion: $CONCLUSION"
              
              if [ "$STATUS" = "completed" ]; then
                case "$CONCLUSION" in
                  success|failure|cancelled|skipped)
                    echo "Release workflow completed with conclusion: $CONCLUSION"
                    exit 0
                    ;;
                  *)
                    echo "Release workflow completed with unexpected conclusion: $CONCLUSION"
                    exit 1
                    ;;
                esac
              fi
            else
              echo "No Release workflow found for commit $REF yet..."
            fi
            
            echo "Waiting ${WAIT_INTERVAL}s for Release workflow..."
            sleep $WAIT_INTERVAL
            ELAPSED=$((ELAPSED + WAIT_INTERVAL))
          done

          echo "Timeout waiting for Release workflow after ${MAX_WAIT}s"
          exit 1

  detect-changes:
    #needs: wait-for-release
    #if: github.event.pull_request.merged == true
    runs-on: self-hosted
    outputs:
      proxmox: ${{ steps.filter.outputs.proxmox }}
      clusters: ${{ steps.filter.outputs.clusters }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            proxmox:
              - 'proxmox/**'
            clusters:
              - 'clusters/**'
              - 'secrets/**'

  # apply-proxmox:
  #   needs: detect-changes
  #   if: needs.detect-changes.outputs.proxmox == 'true'
  #   runs-on: self-hosted
  #   environment: terraform
  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v4
  #       with:
  #         token: ${{ secrets.RUNNER }}
  #         fetch-depth: 0

  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: "20"

  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_version: 1.10.5

  #     - name: Install jq
  #       run: |
  #         if ! command -v jq &> /dev/null; then
  #           sudo apt-get update
  #           sudo apt-get install -y jq
  #         fi

  #     - name: Terraform Init
  #       working-directory: ./proxmox
  #       run: |
  #         terraform init

  #     - name: Terraform Apply
  #       working-directory: ./proxmox
  #       id: apply
  #       run: |
  #         terraform apply -auto-approve

  #     - name: Extract Ansible Playbook from Commit
  #       if: steps.apply.outcome == 'success'
  #       id: extract-playbook
  #       run: |
  #         COMMIT_MSG=$(git log -1 --pretty=format:"%s")
  #         echo "Commit message: $COMMIT_MSG"

  #         if [[ $COMMIT_MSG =~ \[ansible[[:space:]]+([^\]]+)\] ]]; then
  #           PLAYBOOK="${BASH_REMATCH[1]}"
  #           PLAYBOOK=$(echo $PLAYBOOK | xargs)
  #           echo "Found playbook: $PLAYBOOK"
  #           echo "ANSIBLE_PLAYBOOK=$PLAYBOOK" >> $GITHUB_ENV
  #           echo "ANSIBLE_TAG=[ansible $PLAYBOOK]" >> $GITHUB_ENV
  #         else
  #           echo "No ansible command found in commit message"
  #           echo "ANSIBLE_TAG=" >> $GITHUB_ENV
  #         fi

  #     - name: Install Ansible for Inventory Validation
  #       id: install-ansible
  #       if: steps.apply.outcome == 'success'
  #       run: |
  #         python3 -m pip install --upgrade pip
  #         pip install ansible

  #     - name: Update Ansible Inventory
  #       id: update-ansible-inventory
  #       if: steps.install-ansible.outcome == 'success'
  #       run: |
  #         chmod +x proxmox/update-inventory.sh
  #         ./proxmox/update-inventory.sh || echo "Warning: Inventory update script encountered issues but workflow will continue"
  #         touch proxmox/new_hosts.txt

  #     - name: Commit and Push Changes
  #       if: steps.update-ansible-inventory.outcome == 'success'
  #       id: commit-changes
  #       run: |
  #         OWNER_REPO="${GITHUB_REPOSITORY}"
  #         OWNER=$(echo $OWNER_REPO | cut -d '/' -f 1)
  #         REPO=$(echo $OWNER_REPO | cut -d '/' -f 2)

  #         git config --local user.email "actions@github.com"
  #         git config --local user.name "GitHub Actions"
  #         git pull
  #         git add proxmox/k8s.ini proxmox/new_hosts.txt || true

  #         # Check if there are changes to commit
  #         if git diff --quiet && git diff --staged --quiet; then
  #           echo "No changes to commit"
  #           echo "changes_made=false" >> $GITHUB_OUTPUT
  #           exit 0
  #         fi

  #         if [ -n "$ANSIBLE_TAG" ]; then
  #           COMMIT_MSG="Auto-update Ansible inventory $ANSIBLE_TAG"
  #         else
  #           COMMIT_MSG="Auto-update Ansible inventory"
  #         fi

  #         echo "git commit with message: $COMMIT_MSG"
  #         git commit -m "$COMMIT_MSG"
  #         git push

  #         echo "changes_made=true" >> $GITHUB_OUTPUT

  apply-clusters:
    needs: detect-changes
    if: needs.detect-changes.outputs.clusters == 'true'
    runs-on: self-hosted
    environment: terraform
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.5

      - name: Check if triggered by PR merge
        id: pr_check
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Check if this push came from a PR merge
            COMMIT_MESSAGE=$(git log -1 --pretty=%B)
            PR_NUMBER=$(echo "$COMMIT_MESSAGE" | grep -oP 'Merge pull request #\K\d+' || echo "")

            if [ -n "$PR_NUMBER" ]; then
              echo "pr_merged=true" >> $GITHUB_OUTPUT
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "pr_merged=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "pr_merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Init
        run: |
          make init

      - name: Capture Terraform Outputs Before Apply
        id: outputs_before
        run: |
          cd clusters
          mkdir -p /tmp/terraform-outputs

          for workspace in sandboxy tools observability; do
            terraform workspace select $workspace

            if terraform output -json proxmox_talos_cluster_names 2>/dev/null | jq -e '. | length > 0' > /dev/null 2>&1; then
              terraform output -json proxmox_talos_cluster_names > /tmp/terraform-outputs/${workspace}_clusters_before.json
              echo "Captured outputs for workspace: $workspace"
            else
              echo "[]" > /tmp/terraform-outputs/${workspace}_clusters_before.json
            fi
          done

      - name: Terraform Apply
        id: apply
        timeout-minutes: 30
        run: |
          make apply

      - name: Capture Terraform Outputs After Apply
        id: outputs_after
        if: steps.apply.outcome == 'success'
        run: |
          cd clusters

          for workspace in sandboxy tools observability; do
            terraform workspace select $workspace

            if terraform output -json proxmox_talos_cluster_names 2>/dev/null | jq -e '. | length > 0' > /dev/null 2>&1; then
              terraform output -json proxmox_talos_cluster_names > /tmp/terraform-outputs/${workspace}_clusters_after.json
            else
              echo "[]" > /tmp/terraform-outputs/${workspace}_clusters_after.json
            fi
          done

      - name: Detect Cluster Changes
        id: detect_changes
        if: steps.apply.outcome == 'success'
        run: |
          cd /tmp/terraform-outputs
          CHANGES_DETECTED=false
          CHANGED_WORKSPACES=""

          for workspace in sandboxy tools observability; do
            BEFORE=$(cat ${workspace}_clusters_before.json)
            AFTER=$(cat ${workspace}_clusters_after.json)

            if [ "$BEFORE" != "$AFTER" ]; then
              echo "Changes detected in workspace: $workspace"
              echo "Before: $BEFORE"
              echo "After: $AFTER"
              CHANGES_DETECTED=true
              CHANGED_WORKSPACES="$CHANGED_WORKSPACES $workspace"
            fi
          done

          echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_OUTPUT
          echo "changed_workspaces=$CHANGED_WORKSPACES" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build kubeconfig manager
        run: |
          cd cicd-update-kubeconfig
          go build -o kubeconfig-manager ./cmd/cicd-update-kubeconfig
          chmod +x kubeconfig-manager
          # Move binary to repo root for easy access
          mv kubeconfig-manager ../cicd-update-kubeconfig-bin
          cd ..

      - name: Update Kubeconfigs in Vault
        if: steps.apply.outcome == 'success'
        continue-on-error: true
        id: kubeconfig_update
        env:
          VAULT_ADDR: https://vault.fullstack.pw
        run: |
          cd /tmp/terraform-outputs

          # Process changes for each workspace
          for workspace in sandboxy tools observability; do
            echo "Processing workspace: $workspace"

            BEFORE=$(cat ${workspace}_clusters_before.json | jq -r '.[]' 2>/dev/null || echo "")
            AFTER=$(cat ${workspace}_clusters_after.json | jq -r '.[]' 2>/dev/null || echo "")

            # Handle CREATE/UPDATE
            for cluster in $AFTER; do
              echo "Upserting kubeconfig for: $cluster"
              "${GITHUB_WORKSPACE}/cicd-update-kubeconfig-bin" \
                --cluster-name "$cluster" \
                --namespace "$cluster" \
                --vault-path "kv/cluster-secret-store/secrets" \
                --vault-addr "$VAULT_ADDR" \
                --management-context "$workspace" \
                --operation upsert || echo "Warning: Failed to upsert kubeconfig for $cluster"
            done

            # Handle DELETE
            for cluster in $BEFORE; do
              if ! echo "$AFTER" | grep -q "^${cluster}$"; then
                echo "Deleting kubeconfig for: $cluster"
                "${GITHUB_WORKSPACE}/cicd-update-kubeconfig-bin" \
                  --cluster-name "$cluster" \
                  --namespace "$cluster" \
                  --vault-path "kv/cluster-secret-store/secrets" \
                  --vault-addr "$VAULT_ADDR" \
                  --management-context "$workspace" \
                  --operation delete \
                  --skip-readiness-check || echo "Warning: Failed to delete kubeconfig for $cluster"
              fi
            done
          done

      - name: Report Kubeconfig Update Failure
        if: steps.pr_check.outputs.pr_merged == 'true' && steps.kubeconfig_update.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Warning: Kubeconfig Update Failed

              Terraform apply succeeded but kubeconfig synchronization to Vault failed.

              **Manual action required:**
              \`\`\`bash
              make update-kubeconfigs
              \`\`\`

              Check [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
              `
            })

      - name: Add Apply Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Clusters Terraform Apply

              Successfully applied Terraform changes to Kubernetes clusters.

              Apply completed at: ${new Date().toISOString()}
              `
            })
        if: steps.pr_check.outputs.pr_merged == 'true' && steps.apply.outcome == 'success'

      - name: Add Apply Error Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Clusters Terraform Apply Failed

              Failed to apply Terraform changes to Kubernetes clusters.

              Please check the workflow logs for more details.
              `
            })
        if: steps.pr_check.outputs.pr_merged == 'true' && steps.apply.outcome != 'success'
