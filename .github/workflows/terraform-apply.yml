name: Terraform

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - "proxmox/**"
      - "clusters/**"
      - "secrets/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  wait-for-release:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Release Workflow
        run: |
          echo "Waiting for Release workflow to complete..."

          MAX_WAIT=300
          WAIT_INTERVAL=10
          ELAPSED=0
          REF="${{ github.event.pull_request.merge_commit_sha }}"
          REPO="${{ github.repository }}"

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            echo "Checking Release workflow status... (elapsed: ${ELAPSED}s)"
            
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/actions/runs?head_sha=$REF")
            
            RELEASE_RUN=$(echo "$RESPONSE" | jq -r '.workflow_runs[] | select(.name == "Release") | {status: .status, conclusion: .conclusion}')
            
            if [ "$RELEASE_RUN" != "null" ] && [ "$RELEASE_RUN" != "" ]; then
              STATUS=$(echo "$RELEASE_RUN" | jq -r '.status')
              CONCLUSION=$(echo "$RELEASE_RUN" | jq -r '.conclusion')
              
              echo "Release workflow - Status: $STATUS, Conclusion: $CONCLUSION"
              
              if [ "$STATUS" = "completed" ]; then
                case "$CONCLUSION" in
                  success|failure|cancelled|skipped)
                    echo "Release workflow completed with conclusion: $CONCLUSION"
                    exit 0
                    ;;
                  *)
                    echo "Release workflow completed with unexpected conclusion: $CONCLUSION"
                    exit 1
                    ;;
                esac
              fi
            else
              echo "No Release workflow found for commit $REF yet..."
            fi
            
            echo "Waiting ${WAIT_INTERVAL}s for Release workflow..."
            sleep $WAIT_INTERVAL
            ELAPSED=$((ELAPSED + WAIT_INTERVAL))
          done

          echo "Timeout waiting for Release workflow after ${MAX_WAIT}s"
          exit 1

  detect-changes:
    needs: wait-for-release
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    outputs:
      proxmox: ${{ steps.filter.outputs.proxmox }}
      clusters: ${{ steps.filter.outputs.clusters }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            proxmox:
              - 'proxmox/**'
            clusters:
              - 'clusters/**'
              - 'secrets/**'

  apply-proxmox:
    needs: detect-changes
    if: needs.detect-changes.outputs.proxmox == 'true'
    runs-on: self-hosted
    environment: terraform
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RUNNER }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.5

      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Terraform Init
        working-directory: ./proxmox
        run: |
          terraform init

      - name: Terraform Apply
        working-directory: ./proxmox
        id: apply
        run: |
          terraform apply -auto-approve

      - name: Extract Ansible Playbook from PR
        if: steps.apply.outcome == 'success'
        id: extract-playbook
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          COMMIT_MSG="${{ github.event.pull_request.head.label }} ${{ github.event.pull_request.body }}"
          COMBINED="$PR_TITLE $COMMIT_MSG"

          # Look for [ansible playbook-name] pattern in title or body
          if [[ $COMBINED =~ \[ansible[[:space:]]+([^\]]+)\] ]]; then
            PLAYBOOK="${BASH_REMATCH[1]}"
            PLAYBOOK=$(echo $PLAYBOOK | xargs)
            echo "Found playbook: $PLAYBOOK"
            echo "ANSIBLE_PLAYBOOK=$PLAYBOOK" >> $GITHUB_ENV
            echo "ANSIBLE_TAG=[ansible $PLAYBOOK]" >> $GITHUB_ENV
          else
            echo "No ansible command found in PR"
            echo "ANSIBLE_TAG=" >> $GITHUB_ENV
          fi

      - name: Update Ansible Inventory
        if: steps.apply.outcome == 'success'
        run: |
          chmod +x proxmox/update-inventory.sh
          ./proxmox/update-inventory.sh || echo "Warning: Inventory update script encountered issues but workflow will continue"
          touch proxmox/new_hosts.txt

      - name: Commit and Push Changes
        if: steps.apply.outcome == 'success'
        id: commit-changes
        run: |
          OWNER_REPO="${GITHUB_REPOSITORY}"
          OWNER=$(echo $OWNER_REPO | cut -d '/' -f 1)
          REPO=$(echo $OWNER_REPO | cut -d '/' -f 2)

          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          # Add the updated files
          git add proxmox/k8s.ini proxmox/new_hosts.txt || true

          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes_made=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Use ansible tag as commit message if present
          if [ -n "$ANSIBLE_TAG" ]; then
            COMMIT_MSG="$ANSIBLE_TAG"
          else
            COMMIT_MSG="Auto-update Ansible inventory"
          fi

          echo "git commit with message: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"
          git push

          echo "changes_made=true" >> $GITHUB_OUTPUT

  apply-clusters:
    needs: detect-changes
    if: needs.detect-changes.outputs.clusters == 'true'
    runs-on: self-hosted
    environment: terraform
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.5

      - name: Terraform Init
        run: |
          make init

      - name: Terraform Apply
        id: apply
        run: |
          make apply

      - name: Add Apply Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Clusters Terraform Apply
              
              ✅ Successfully applied Terraform changes to Kubernetes clusters.
              
              Apply completed at: ${new Date().toISOString()}
              `
            })
        if: steps.apply.outcome == 'success'

      - name: Add Apply Error Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Clusters Terraform Apply Failed
              
              ❌ Failed to apply Terraform changes to Kubernetes clusters.
              
              Please check the workflow logs for more details.
              `
            })
        if: steps.apply.outcome != 'success'
