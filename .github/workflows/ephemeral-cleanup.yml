name: Ephemeral Cluster Cleanup

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  cleanup:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List ephemeral clusters
        id: list
        run: |
          export VAULT_ADDR=https://vault.fullstack.pw
          export VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}

          echo "Checking for ephemeral clusters to clean up..."
          ./clusters/scripts/ip_pool_manager.sh list > /tmp/allocations.txt
          cat /tmp/allocations.txt

      - name: Check cluster ages and cleanup
        run: |
          export VAULT_ADDR=https://vault.fullstack.pw
          export VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}

          # Get all ephemeral clusters from Cluster API
          CLUSTERS=$(kubectl get cluster -A -l ephemeral=true --context tools -o json)

          # Current timestamp
          NOW=$(date +%s)
          THREE_DAYS_AGO=$((NOW - 259200))  # 3 days in seconds

          echo "$CLUSTERS" | jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name) \(.metadata.creationTimestamp)"' | while read -r namespace name created; do
            CREATED_TS=$(date -d "$created" +%s)
            AGE_DAYS=$(( (NOW - CREATED_TS) / 86400 ))

            echo "Cluster: $name, Age: $AGE_DAYS days"

            if [ $CREATED_TS -lt $THREE_DAYS_AGO ]; then
              echo "⚠️ Cluster $name is older than 3 days. Scheduling for deletion..."

              # Delete cluster
              kubectl delete cluster $name -n $namespace --context tools

              # Release IP
              ./clusters/scripts/ip_pool_manager.sh release "$name"

              # Remove kubeconfig
              vault kv delete kv/ephemeral-clusters/${name}/kubeconfig || true

              echo "✅ Deleted stale cluster: $name"
            fi
          done

      - name: Check for orphaned IP allocations
        run: |
          export VAULT_ADDR=https://vault.fullstack.pw
          export VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}

          echo "Checking for orphaned IP allocations..."

          # Get all allocated IPs from Vault
          ALLOCATIONS=$(vault kv get -format=json kv/ephemeral-clusters/ip-allocations | jq -r '.data.data // {}')

          # Get all active clusters from Cluster API
          ACTIVE_CLUSTERS=$(kubectl get cluster -A -l ephemeral=true --context tools -o jsonpath='{.items[*].metadata.name}')

          echo "$ALLOCATIONS" | jq -r 'to_entries[] | "\(.value)"' | while read -r cluster_name; do
            if ! echo "$ACTIVE_CLUSTERS" | grep -q "$cluster_name"; then
              echo "⚠️ Found orphaned IP allocation for: $cluster_name"
              ./clusters/scripts/ip_pool_manager.sh release "$cluster_name"
              echo "✅ Released orphaned IP for: $cluster_name"
            fi
          done

      - name: Send cleanup summary
        if: always()
        run: |
          echo "Ephemeral cluster cleanup completed at $(date)"
          export VAULT_ADDR=https://vault.fullstack.pw
          export VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}
          ./clusters/scripts/ip_pool_manager.sh list
